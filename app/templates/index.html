<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph Multi-Agent SQL QA System with SQL-to-NLP</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .sql-to-nlp-section {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .feature-highlight {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .sql-input {
            width: 100%;
            height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🤖 LangGraph Multi-Agent SQL QA System</h1>
            <p class="subtitle">With SQL-to-NLP Conversion Capabilities</p>
            <p>Water Supply and Sanitation Department - Government of Maharashtra</p>
        </header>

        <div class="feature-highlight">
            <h2>🆕 New Feature: SQL-to-NLP Conversion</h2>
            <p>Now you can convert SQL queries to natural language descriptions!</p>
        </div>

        <div class="system-status" id="systemStatus">
            <h2>📊 System Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Database:</span>
                    <span class="status-value" id="dbStatus">Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Ollama LLM:</span>
                    <span class="status-value" id="ollamaStatus">Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">SQL-to-NLP:</span>
                    <span class="status-value" id="sqlToNlpStatus">Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Agents:</span>
                    <span class="status-value" id="agentStatus">Checking...</span>
                </div>
            </div>
        </div>

        <div class="agents-section">
            <h2>🎯 Specialized Agents</h2>
            <div class="agents-grid">
                <div class="agent-card">
                    <h3>📍 Location Agent</h3>
                    <p>Districts, circles, blocks, villages, administrative boundaries</p>
                </div>
                <div class="agent-card">
                    <h3>👥 User Agent</h3>
                    <p>Citizens, registrations, accounts, user management</p>
                </div>
                <div class="agent-card">
                    <h3>📝 Grievance Agent</h3>
                    <p>Complaints, grievances, issues, resolutions</p>
                </div>
                <div class="agent-card">
                    <h3>🏛️ Schemes Agent</h3>
                    <p>Government schemes, programs, initiatives</p>
                </div>
                <div class="agent-card">
                    <h3>📊 Tracker Agent</h3>
                    <p>Status tracking, progress monitoring, logs</p>
                </div>
                <div class="agent-card">
                    <h3>🎯 Router Agent</h3>
                    <p>Intelligent question routing and response generation</p>
                </div>
                <div class="agent-card feature-highlight">
                    <h3>🔄 SQL-to-NLP Agent</h3>
                    <p>Converts SQL queries to natural language descriptions</p>
                </div>
            </div>
        </div>

        <div class="query-section">
            <h2>💬 Ask a Question</h2>
            <div class="input-group">
                <textarea id="questionInput" placeholder="Ask about districts, schemes, grievances, users, or tracking...">Show me all districts in Maharashtra</textarea>
                <select id="responseStyle">
                    <option value="brief">Brief Response</option>
                    <option value="normal">Normal Response</option>
                    <option value="detailed">Detailed Response</option>
                </select>
                <button onclick="askQuestion()">Ask Question</button>
            </div>
        </div>

        <div class="sql-to-nlp-section">
            <h2>🔄 SQL-to-NLP Converter</h2>
            <p>Convert SQL queries to natural language descriptions</p>
            <div class="input-group">
                <textarea id="sqlInput" class="sql-input" placeholder="Enter your SQL query here...">SELECT district_name, COUNT(*) as total_grievances FROM districts d JOIN grievances g ON d.id = g.district_id WHERE g.status = 'pending' GROUP BY district_name ORDER BY total_grievances DESC LIMIT 10</textarea>
                <input type="text" id="contextInput" placeholder="Optional context for better explanation..." />
                <label>
                    <input type="checkbox" id="includeAnalysis"> Include detailed analysis
                </label>
                <button onclick="explainSQL()">Explain SQL Query</button>
            </div>
        </div>

        <div class="response-section">
            <h2>📋 Response</h2>
            <div id="response" class="response-box">Ask a question or provide a SQL query to see the response here...</div>
        </div>

        <div class="api-info">
            <h2>🔗 API Endpoints</h2>
            <div class="endpoint-list">
                <div class="endpoint-group">
                    <h3>Core Functionality</h3>
                    <ul>
                        <li><code>POST /api/ask</code> - Ask natural language questions</li>
                        <li><code>POST /api/ask_batch</code> - Process multiple questions</li>
                        <li><code>GET /api/tables</code> - Get database schema information</li>
                        <li><code>GET /api/health</code> - System health check</li>
                    </ul>
                </div>
                <div class="endpoint-group">
                    <h3>🆕 SQL-to-NLP Features</h3>
                    <ul>
                        <li><code>POST /api/explain_sql</code> - Convert SQL query to natural language</li>
                        <li><code>POST /api/explain_sql_batch</code> - Batch SQL to NLP conversion</li>
                        <li><code>POST /api/analyze_query</code> - Detailed SQL query analysis</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // Add SQL-to-NLP functionality
        async function explainSQL() {
            const sqlQuery = document.getElementById('sqlInput').value.trim();
            const context = document.getElementById('contextInput').value.trim();
            const includeAnalysis = document.getElementById('includeAnalysis').checked;
            
            if (!sqlQuery) {
                alert('Please enter a SQL query to explain.');
                return;
            }
            
            const responseDiv = document.getElementById('response');
            responseDiv.innerHTML = '<div class="loading">🔄 Converting SQL to natural language...</div>';
            
            try {
                const response = await fetch('/api/explain_sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sql_query: sqlQuery,
                        context: context,
                        include_analysis: includeAnalysis,
                        language: 'en'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let output = `
                        <div class="result-success">
                            <h3>🔄 SQL-to-NLP Conversion Result</h3>
                            <div class="result-section">
                                <h4>📝 Natural Language Description:</h4>
                                <p class="description">${result.description}</p>
                            </div>
                            <div class="result-section">
                                <h4>🔍 Query Details:</h4>
                                <p><strong>Complexity:</strong> ${result.complexity}</p>
                                <p><strong>Safety Status:</strong> ${result.is_safe ? '✅ Safe' : '❌ Unsafe'}</p>
                                <p><strong>Processed by:</strong> ${result.agent} agent</p>
                            </div>
                    `;
                    
                    if (result.analysis) {
                        output += `
                            <div class="result-section">
                                <h4>📊 Detailed Analysis:</h4>
                                <pre class="analysis">${result.analysis}</pre>
                            </div>
                        `;
                    }
                    
                    output += '</div>';
                    responseDiv.innerHTML = output;
                } else {
                    responseDiv.innerHTML = `<div class="result-error">❌ Error: ${result.detail || 'Unknown error occurred'}</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = `<div class="result-error">❌ Network Error: ${error.message}</div>`;
            }
        }
        
        // Update status check to include SQL-to-NLP
        async function checkSystemStatus() {
            try {
                const response = await fetch('/health');
                const status = await response.json();
                
                updateStatusIndicator('dbStatus', status.database || 'unknown');
                updateStatusIndicator('ollamaStatus', status.llm || status.ollama_status || 'unknown');
                updateStatusIndicator('sqlToNlpStatus', status.sql_to_nlp || 'unknown');
                updateStatusIndicator('agentStatus', status.agents || 'unknown');
                
            } catch (error) {
                console.error('Status check failed:', error);
                updateStatusIndicator('dbStatus', 'error');
                updateStatusIndicator('ollamaStatus', 'error');
                updateStatusIndicator('sqlToNlpStatus', 'error');
                updateStatusIndicator('agentStatus', 'error');
            }
        }
        
        // Enhanced status updates for SQL-to-NLP
        checkSystemStatus();
        setInterval(checkSystemStatus, 30000); // Check every 30 seconds
    </script>
</body>
</html>